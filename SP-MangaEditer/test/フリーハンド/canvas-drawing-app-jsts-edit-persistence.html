<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><style>body{margin:0;display:flex;flex-direction:column;align-items:center;padding-top:20px;background:#f0f0f0}#c{border:1px solid #000;margin-bottom:10px}#m,#st{display:flex;gap:5px;margin-bottom:10px;align-items:center}.a{background:#4CAF50;color:#fff}#sr,#st>div{display:flex;align-items:center;gap:10px}</style></head><body><canvas id="c" width="600" height="400"></canvas><div id="m"><button id="aa">座標</button><button id="bb">自由</button><button id="dd">移動</button><button id="ff">追加</button><button id="gg">削除</button><button id="ee">消去</button></div><div id="st"><div><label for="fc">塗色:</label><input type="color" id="fc" value="#FFFFFF"></div><div><label for="sc">線色:</label><input type="color" id="sc" value="#000000"></div><div><label for="sw">線幅:</label><input type="number" id="sw" min="1" max="20" value="2"></div><div><label for="fa">透明:</label><input type="range" id="fa" min="0" max="100" value="100"><span id="fav">100</span></div></div><div id="sr"><label for="sm">滑:</label><input type="range" id="sm" min="0" max="100" value="50"><span id="sv">50</span></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jsts/2.9.3/jsts.min.js"></script><script>const c=document.getElementById('c'),x=c.getContext('2d'),a=document.getElementById("aa"),b=document.getElementById("bb"),d=document.getElementById("dd"),f=document.getElementById("ff"),g=document.getElementById("gg"),e=document.getElementById("ee"),m=document.getElementById("sm"),v=document.getElementById("sv"),h=document.getElementById("fc"),i=document.getElementById("sc"),j=document.getElementById("sw"),k=document.getElementById("fa"),l=document.getElementById("fav"),t=30,n=new jsts.geom.GeometryFactory(new jsts.geom.PrecisionModel(1e6));let o="point",p=[],q=null,r=[],s=!1,u=[],w=-1,y=[],z=-1;function A(B){[a,b,d,f,g].forEach(C=>C.classList.remove("a"));B.classList.add("a")}function D(E,F=false,G=null){x.beginPath();const H=E.getCoordinates();H.forEach((I,J)=>{J===0?x.moveTo(I.x,I.y):x.lineTo(I.x,I.y)});x.closePath();if(F){x.fillStyle="rgba(0,0,255,0.2)";x.strokeStyle="blue";x.lineWidth=parseInt(j.value)}else{x.fillStyle=G.fillColor;x.strokeStyle=G.strokeColor;x.lineWidth=G.strokeWidth}x.fill();x.stroke()}function K(){x.clearRect(0,0,c.width,c.height);r.forEach((E,F)=>{if(F===w&&["edit","add","delete"].includes(o)){D(L(y),true)}else{D(E,false,E.style)}});if(["edit","add","delete"].includes(o)&&w!==-1){y.forEach((E,F)=>{x.beginPath();x.arc(E.x,E.y,5,0,2*Math.PI);x.fillStyle=F===z?"red":"blue";x.fill()})}if(o==="point"&&p.length>0){x.beginPath();x.moveTo(p[0].x,p[0].y);p.forEach(E=>x.lineTo(E.x,E.y));q&&x.lineTo(q.x,q.y);x.fillStyle="rgba(0,0,255,0.2)";x.fill();x.strokeStyle="blue";x.lineWidth=parseInt(j.value);x.stroke()}else if(o==="freehand"&&u.length>0){x.beginPath();x.moveTo(u[0].x,u[0].y);u.forEach(E=>x.lineTo(E.x,E.y));x.fillStyle="rgba(0,0,255,0.2)";x.fill();x.strokeStyle="blue";x.lineWidth=parseInt(j.value);x.stroke()}}function L(M){if(M.length<3)return null;let N=M.map(E=>new jsts.geom.Coordinate(Math.round(E.x*10)/10,Math.round(E.y*10)/10));if(N[0].x!==N[N.length-1].x||N[0].y!==N[N.length-1].y){N.push(new jsts.geom.Coordinate(N[0].x,N[0].y))}try{const O=n.createLinearRing(N);return n.createPolygon(O)}catch(P){return null}}function Q(R,S){try{const T=R.union(S),U=jsts.simplify.TopologyPreservingSimplifier.simplify(T,.1);const V=jsts.precision.GeometryPrecisionReducer.reduce(U,new jsts.geom.PrecisionModel(1e6));V.style=Ha();return V}catch(W){return R}}function W(X){let Y=X;for(let F=r.length-1;F>=0;F--)if(Y.intersects(r[F])||Y.touches(r[F])){const Z=Q(Y,r[F]);Z&&Z.isValid()&&(Y=Z,r.splice(F,1))}Y.style=Ha();return Y}function aa(ba,ca){let da=1/0,ea=-1;y.forEach((E,F)=>{const fa=Math.hypot(E.x-ba,E.y-ca);fa<da&&(da=fa,ea=F)});return{index:ea,distance:da}}function ga(ba,ca){let da=1/0,ha=null,ea=-1,ia=-1;for(let F=0;F<y.length;F++){const ja=y[F],ka=y[(F+1)%y.length];const la=ma(ba,ca,ja.x,ja.y,ka.x,ka.y);const fa=Math.hypot(ba-la.x,ca-la.y);if(fa<da){da=fa;ha=la;ea=F;ia=(F+1)%y.length}}return{point:ha,distance:da,index1:ea,index2:ia}}function ma(na,oa,pa,qa,ra,sa){const ta=ra-pa,ua=sa-qa;const va=((na-pa)*ta+(oa-qa)*ua)/(ta*ta+ua*ua);return{x:pa+va*ta,y:qa+va*ua}}function wa(ba,ca,xa){return Math.abs(ba-xa.x)<=15&&Math.abs(ca-xa.y)<=15}function Aa(Ba,Ca){if(Ba.length<3)return Ba;let Da=[Ba[0]];for(let F=1;F<Ba.length-1;F++){let Ea=Ba[F-1],Fa=Ba[F],Ga=Ba[F+1];Da.push({x:Fa.x*(1-Ca)+Ca*(Ea.x+Ga.x)/2,y:Fa.y*(1-Ca)+Ca*(Ea.y+Ga.y)/2})}Da.push(Ba[Ba.length-1]);return Da}function Ha(){return{fillColor:`${h.value}${Math.round(k.value*2.55).toString(16).padStart(2,'0')}`,strokeColor:i.value,strokeWidth:parseInt(j.value)}}c.addEventListener("mousedown",Ia=>{if(o==="point"){const{offsetX:ba,offsetY:ca}=Ia;p.push(new jsts.geom.Coordinate(ba,ca));K()}else if(o==="freehand"){s=!0;u=[new jsts.geom.Coordinate(Ia.offsetX,Ia.offsetY)];K()}else if(["edit","add","delete"].includes(o)){const{offsetX:ba,offsetY:ca}=Ia;if(o==="edit"){const{index:ea,distance:da}=aa(ba,ca);if(ea!==-1){z=ea;s=!0}}else if(o==="add"){const{point:ha,distance:da,index1:ea,index2:ia}=ga(ba,ca);if(da<=10){y.splice(ea+1,0,ha);z=ea+1;s=!0}}else if(o==="delete"){const{index:ea,distance:da}=aa(ba,ca);if(ea!==-1&&y.length>3){y.splice(ea,1);const Ja=L(y);if(Ja&&Ja.isValid()){r[w]=Ja;}}}K()}});c.addEventListener("mousemove",Ia=>{if(o==="point"){q=new jsts.geom.Coordinate(Ia.offsetX,Ia.offsetY);K()}else if(o==="freehand"&&s){u.push(new jsts.geom.Coordinate(Ia.offsetX,Ia.offsetY));K()}else if(o==="edit"&&s&&z!==-1){y[z].x=Ia.offsetX;y[z].y=Ia.offsetY;K()}else if(o==="add"){const{offsetX:ba,offsetY:ca}=Ia;const{distance:da}=ga(ba,ca);c.style.cursor=da<=10?"crosshair":"default"}});c.addEventListener("mouseup",Ia=>{if(o==="point"&&p.length>=3){const{offsetX:ba,offsetY:ca}=Ia;if(wa(ba,ca,p[0])){p.push(new jsts.geom.Coordinate(p[0].x,p[0].y));const Ja=L(p);if(Ja&&Ja.isValid()){Ja.style=Ha();const Ka=W(Ja);Ka&&Ka.isValid()?(r.push(Ka),p=[],q=null,K()):null}}else{p.push(new jsts.geom.Coordinate(ba,ca));K()}}else if(o==="freehand"){if(s=!1,u.length>=4){if(wa(u[u.length-1].x,u[u.length-1].y,u[0])){u.push(new jsts.geom.Coordinate(u[0].x,u[0].y))}const La=parseInt(m.value)/100;u=Aa(u,La);const Ja=L(u);if(Ja&&Ja.isValid()){Ja.style=Ha();const Ka=W(Ja);Ka&&Ka.isValid()?r.push(Ka):null}u=[];K()}}else if(["edit","add","delete"].includes(o)&&(s=!1,z!==-1)){const Ja=L(y);if(Ja&&Ja.isValid()){Ja.style=Ha();r[w]=W(Ja);}K();z=-1}});a.addEventListener("click",()=>{o="point";A(a);p=[];q=null;u=[];w=-1;y=[];K()});b.addEventListener("click",()=>{o="freehand";A(b);p=[];q=null;u=[];w=-1;y=[];K()});d.addEventListener("click",()=>{o="edit";A(d);w=r.length-1;w>=0&&(y=r[w].getCoordinates().map(E=>({x:E.x,y:E.y})));K()});f.addEventListener("click",()=>{o="add";A(f);w=r.length-1;w>=0&&(y=r[w].getCoordinates().map(E=>({x:E.x,y:E.y})));K()});g.addEventListener("click",()=>{o="delete";A(g);w=r.length-1;w>=0&&(y=r[w].getCoordinates().map(E=>({x:E.x,y:E.y})));K()});e.addEventListener("click",()=>{r=[];p=[];q=null;u=[];w=-1;y=[];z=-1;K()});m.addEventListener("input",()=>{v.textContent=m.value});[h,i,j,k].forEach(E=>E.addEventListener("input",()=>{l.textContent=k.value;K()}));A(a);K();</script></body></html>